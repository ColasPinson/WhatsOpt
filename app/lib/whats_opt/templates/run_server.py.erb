#!/usr/bin/env python

from thrift.transport import TSocket
from thrift.transport import TTransport
from thrift.protocol import TBinaryProtocol
from thrift.server import TServer

from <%= @server_module %>.<%= @mda.py_modulename %> import <%= @mda.py_classname %> as <%= @mda.camelname %>Service
from <%= @server_module %>.<%= @mda.py_modulename %>_conversions import *
from <%= @mda.py_modulename %> import <%= @mda.py_classname %> as Factory

class <%= @mda.camelname %>Handler:
    def __init__(self):
        factory = Factory()
        <% @mda.disciplines.nodes.each do |disc| %>
        self.<%= disc.basename %> = factory.create_<%= disc.basename %>()
        <% end %>

    <% @mda.disciplines.nodes.each do |disc| %>
    def compute_<%= disc.basename %>(self, ins):
        outputs = {}
        inputs = to_openmdao_<%= disc.basename %>_inputs(ins)
        self.<%= disc.basename %>.compute(inputs, outputs)
        return to_thrift_<%= disc.basename %>_output(outputs)
    <% end %>

handler = SellarHandler()
processor = SellarService.Processor(handler)
transport = TSocket.TServerSocket(port=31400)
tfactory = TTransport.TBufferedTransportFactory()
pfactory = TBinaryProtocol.TBinaryProtocolFactory()

server = TServer.TSimpleServer(processor, transport, tfactory, pfactory)

print("Starting python server...")
server.serve()
print("done!")
