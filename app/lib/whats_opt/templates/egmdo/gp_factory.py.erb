import numpy as np
import openmdao.api as om
import subprocess
from smt.surrogate_models import KRG
import pickle

class GpFactory:
<%- @mda.plain_disciplines.each do |disc| -%>
<% disc.output_variables.each do |v| %>
    @staticmethod
    def create_gp_<%= disc.snake_modulename %>_<%= v.py_varname %>():
        # read the doe and create the GP
        cr = om.CaseReader(f"sellar_<%= disc.snake_modulename %>_doe.sqlite")
        driver_cases = cr.list_cases("driver")
        case = cr.get_case(driver_cases[0])
        n_doe = len(driver_cases)
        dim=<%= disc.variables.map(&:dim).inject(0, :+) %>
        doe = np.zeros((n_doe, dim))
        
        for i in range(n_doe):
            case = cr.get_case(driver_cases[i])
<%- index = 0 -%>
<%- (disc.input_variables + disc.output_variables).each_with_index do |var, i| -%>
            doe[i, <%= index %>:<%= index + var.dim %>] = case.outputs['<%= var.name %>']
<%- index = index + var.dim -%>
<%- end -%>

        # save the DoE for futur enrichement
        np.save("doe_<%= disc.snake_modulename %>.npy", doe)

        # create the gp surrogate model
        input_dim=<%= disc.input_variables.map(&:dim).inject(0, :+) %>
        gp = KRG(theta0=[1e-2] * input_dim, print_global=False)
        gp.set_training_values(doe[:, 0:-1], doe[:, -1])
        gp.train()
        with open("gp_<%= disc.snake_modulename %>_<%= v.py_varname %>.pkl", "wb") as f:
            pickle.dump(gp, f)
<%- end %>
<%- end %>
